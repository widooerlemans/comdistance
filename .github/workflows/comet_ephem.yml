# augment_names.py
from pathlib import Path
import json, re

OUT = Path("data/comets_ephem.json")
COBS = Path("data/cobs_list.json")

if not OUT.exists():
    raise SystemExit("data/comets_ephem.json not found (run horizons_pull.py first)")

# Load your output (we won't change anything except the 3 name fields)
data = json.loads(OUT.read_text(encoding="utf-8"))
items = data.get("items", [])

# Build a map from COBS designation -> full name string
cobs_map = {}
if COBS.exists():
    c = json.loads(COBS.read_text(encoding="utf-8"))
    for o in c.get("comet_list", []):
        desig = (o.get("comet_name") or "").strip()      # e.g. "C/2025 A6" or "24P" or "141P-B"
        full  = (o.get("comet_fullname") or "").strip()  # e.g. "C/2025 A6 (Lemmon)" or "24P/Schaumasse"
        if desig and full:
            cobs_map[desig] = full

# Helpers
PAREN = re.compile(r"\(([^)]+)\)\s*$")

def suffix_from_full(full: str | None) -> str | None:
    """Return 'Lemmon' from 'C/2025 A6 (Lemmon)', or 'Schaumasse' from '24P/Schaumasse'."""
    if not full:
        return None
    m = PAREN.search(full)
    if m:
        return m.group(1).strip() or None
    if "/" in full:
        tail = full.split("/", 1)[1].strip()
        return tail or None
    return None

def get_desig(it: dict) -> str | None:
    """Find the designation in your item (works with your old schema)."""
    for k in ("desig", "designation", "id", "desig_str", "comet_name"):
        v = it.get(k)
        if isinstance(v, str) and v.strip():
            return v.strip()
    # Fallback from a COBS fullname if present in the item already
    cf = it.get("cobs_fullname")
    if isinstance(cf, str) and cf.strip():
        s = cf.strip()
        # "24P/Schaumasse" -> "24P"
        if "/" in s and "(" not in s:
            return s.split("/", 1)[0].strip()
        # "C/2025 A6 (Lemmon)" -> "C/2025 A6"
        m = PAREN.search(s)
        if m:
            return s[:m.start()].strip()
    return None

updated = 0
for it in items:
    desig = get_desig(it) or ""
    # If the item doesn't already have a COBS fullname, try to attach one from the planner
    if not it.get("cobs_fullname") and desig in cobs_map:
        it["cobs_fullname"] = cobs_map[desig]

    full = it.get("cobs_fullname")
    suf = suffix_from_full(full)

    # Build canonical name_full / display_name
    if suf:
        # Periodic short forms often use slash: "24P/Schaumasse", "3I/ATLAS"
        if ("/" in desig) and ("(" not in desig):
            name_full = f"{desig}/{suf}"
        else:
            name_full = f"{desig} ({suf})"
    else:
        # If we couldn't extract a suffix, fall back gracefully
        name_full = full or (desig or None)

    # Only set the three name fields; leave all other fields (distances, v_pred, etc.) intact
    if "name_suffix" not in it and suf is not None:
        it["name_suffix"] = suf
        updated += 1
    if "name_full" not in it and name_full is not None:
        it["name_full"] = name_full
        updated += 1
    if "display_name" not in it and name_full is not None:
        it["display_name"] = name_full
        updated += 1

# Write back compact JSON (unchanged fields preserved verbatim)
OUT.write_text(json.dumps(data, ensure_ascii=False, separators=(",", ":")), encoding="utf-8")
print(f"Augmented fields: {updated}")
